version: '3'

services:
  # =========================================
  # 1. TOR (Fixed: Runs as 'tor' user)
  # =========================================
  tor:
    image: alpine:latest
    container_name: hydra-tor
    # COMMAND EXPLANATION:
    # 1. Install Tor
    # 2. Give 'tor' user ownership of data folder
    # 3. Switch user to 'tor' and run the daemon
    command: >
      sh -c "apk add --no-cache tor &&
             chown -R tor /var/lib/tor &&
             su tor -c 'tor -f /etc/tor/torrc'"
    volumes:
      - ./torrc:/etc/tor/torrc
    restart: always
    logging: { driver: none }
    networks: [ hydra-net ]
    mem_limit: 256m
    cpus: 0.5

  # =========================================
  # 2. XRAY (Client Handler)
  # =========================================
  xray:
    image: teddysun/xray:latest
    container_name: hydra-xray
    entrypoint: /bin/sh /etc/xray/entrypoint.sh
    volumes:
      - ./xray/config.json:/etc/xray/config.json
      - ./xray/entrypoint.sh:/etc/xray/entrypoint.sh
    environment:
      - HYDRA_UUID=${HYDRA_UUID}
    restart: always
    depends_on: [ tor ]
    logging: { driver: none }
    networks: [ hydra-net ]
    mem_limit: 256m
    cpus: 0.3

  # =========================================
  # 3. CLOUDFLARE TUNNEL
  # =========================================
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: hydra-tunnel
    command: tunnel run --token ${HYDRA_TOKEN}
    restart: always
    depends_on: [ xray ]
    logging: { driver: none }
    networks: [ hydra-net ]
    mem_limit: 256m
    cpus: 0.3

  # =========================================
  # 4. BOT (Controller)
  # =========================================
  bot:
    build: ./bot
    container_name: hydra-bot
    environment:
      - TG_BOT_TOKEN=${TG_BOT_TOKEN}
      - TG_ADMIN_ID=${TG_ADMIN_ID}
      - HYDRA_UUID=${HYDRA_UUID}
      - VPN_DOMAIN=${VPN_DOMAIN}
    restart: always
    logging: { driver: none }
    networks: [ hydra-net ]
    mem_limit: 128m
    cpus: 0.2

networks:
  hydra-net:
    driver: bridge
